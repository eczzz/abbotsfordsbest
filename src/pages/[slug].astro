---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import BusinessCard from '../components/BusinessCard.astro';
import Footer from '../components/Footer.astro';
import { getSupabase } from '../lib/supabaseClient.js';

const { slug } = Astro.params;

// Fetch category page data
const supabase = getSupabase(Astro);
const { data: categoryPage, error: categoryError } = await supabase
  .from('category_pages')
  .select('*')
  .eq('slug', slug)
  .single();

if (categoryError || !categoryPage) {
  return Astro.redirect('/404');
}

// Fetch featured businesses
const featuredBusinessIds = [
  categoryPage.featured_business_1_id,
  categoryPage.featured_business_2_id,
  categoryPage.featured_business_3_id
].filter(Boolean);

let featuredBusinesses = [];
if (featuredBusinessIds.length > 0) {
  const { data: businesses, error: businessError } = await supabase
    .from('business_submissions')
    .select('*')
    .in('id', featuredBusinessIds)
    .eq('status', 'approved');
  
  if (!businessError && businesses) {
    // Sort businesses to match the order they were featured
    featuredBusinesses = featuredBusinessIds.map(id => 
      businesses.find(business => business.id === id)
    ).filter(Boolean);
  }
}

// Fetch friends businesses for this category
const { data: friendsBusinesses, error: friendsError } = await supabase
  .from('business_submissions')
  .select('*')
  .eq('status', 'approved')
  .eq('friends', true)
  .contains('categories', [slug]);

if (friendsError) {
  console.error('Error fetching friends businesses:', friendsError);
}

// Fetch similar businesses for this category
const { data: similarBusinesses, error: similarError } = await supabase
  .from('business_submissions')
  .select('*')
  .eq('status', 'approved')
  .eq('similar', true)
  .contains('categories', [slug]);

if (similarError) {
  console.error('Error fetching similar businesses:', similarError);
}

// Transform business data for BusinessCard component
const transformedBusinesses = featuredBusinesses.map(business => ({
  name: business.name,
  logo: business.logo_url,
  rating: 5, // Default rating since we don't have ratings in the database yet
  bio: business.description,
  address: business.address,
  phone: business.phone,
  email: business.email,
  website: business.website
}));

// Transform friends businesses
const transformedFriendsBusinesses = (friendsBusinesses || []).map(business => ({
  name: business.name,
  logo: business.logo_url,
  rating: 5,
  bio: business.description,
  address: business.address,
  phone: business.phone,
  email: business.email,
  website: business.website
}));

// Transform similar businesses
const transformedSimilarBusinesses = (similarBusinesses || []).map(business => ({
  name: business.name,
  logo: business.logo_url,
  rating: 5,
  bio: business.description,
  address: business.address,
  phone: business.phone,
  email: business.email,
  website: business.website
}));

// Generate placeholder businesses if we have fewer than 3
const placeholderCount = Math.max(0, 3 - transformedSimilarBusinesses.length);
const placeholderBusinesses = [];
for (let i = 0; i < placeholderCount; i++) {
  placeholderBusinesses.push({
    name: "Your Business",
    address: "123 Your Address St, Abbotsford, BC V2S",
    phone: "(604) 555-1234",
    email: "info@yourbusiness.com",
    website: "https://yourbusiness.com"
  });
}
---

<Layout title={categoryPage.page_title} description={categoryPage.description}>
  <Header />

  <!-- Category Hero -->
  <section class="bg-primary-700 text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="text-4xl lg:text-5xl font-bold mb-6">{categoryPage.category_name}</h1>
        <p class="text-xl text-primary-100 max-w-3xl mx-auto leading-relaxed">
          {categoryPage.description}
        </p>
      </div>
    </div>
  </section>

  <!-- Featured Businesses -->
  {transformedBusinesses.length > 0 && (
    <section class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {transformedBusinesses.map((business) => (
            <BusinessCard business={business} variant="featured" />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Friends of Abbotsford's Best -->
  {transformedFriendsBusinesses.length > 0 && (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">Friends Of Abbotsford's Best</h2>
          <p class="text-gray-600 mb-8">
            These are businesses who support Abbotsford's Best by linking back to us. 
            We're proud to feature them as Friends of Abbotsford's Best!
          </p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
          {transformedFriendsBusinesses.map((business) => (
            <BusinessCard business={business} variant="minimal" />
          ))}
        </div>
        
        <div class="text-center">
          <a href="/list-business" class="bg-primary-700 text-white px-8 py-3 rounded-xl hover:bg-primary-800 transition-colors duration-200 font-medium">
            List Your Business
          </a>
        </div>
      </div>
    </section>
  )}

  {transformedFriendsBusinesses.length === 0 && (
    <section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold text-gray-900 mb-4">Friends Of Abbotsford's Best</h2>
      <p class="text-gray-600 mb-8">
        These are unpaid listings from businesses who support Abbotsford's Best by linking back to us. 
        We're proud to feature them as Friends of Abbotsford's Best!
      </p>
      
      <div class="mb-8">
        <a href="/list-business" class="bg-primary-700 text-white px-8 py-3 rounded-xl hover:bg-primary-800 transition-colors duration-200 font-medium">
          List Your Business
        </a>
      </div>
      
      <div class="bg-gray-50 rounded-2xl p-8 mb-8">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Feature Your Business Here - For Free!</h3>
        <div class="grid md:grid-cols-2 gap-8 items-center">
          <div class="text-left">
            <h4 class="font-semibold text-gray-900 mb-2">How to Get Listed:</h4>
            <p class="text-sm text-gray-600 mb-4">
              Add a link back to <strong>Abbotsford's Best</strong> on your website, or add our badge to your footer.
            </p>
            <p class="text-sm text-gray-600 mb-4">
              Embed this code on your site:
            </p>
            <div class="bg-white p-4 rounded-lg border text-xs font-mono text-gray-700 mb-4">
              &lt;a href="https://abbotsfords.best"&gt;<br/>
              &nbsp;&nbsp;&lt;img src="badge.png" alt="Abbotsford's Best"&gt;<br/>
              </a>
            </div>
            <button class="bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary-800 transition-colors duration-200">
              Copy to Clipboard
            </button>
          </div>
          <div class="text-center">
            <h4 class="font-semibold text-gray-900 mb-2">Example in Footer</h4>
            <div class="bg-gray-800 rounded-lg shadow-lg p-4">
              <img src="https://images.pexels.com/photos/590022/pexels-photo-590022.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Website footer example" class="w-full rounded" />
            </div>
          </div>
        </div>
      </div>

      <a href="/list-business" class="bg-primary-700 text-white px-8 py-3 rounded-xl hover:bg-primary-800 transition-colors duration-200 font-medium">
        List Your Business
      </a>
    </div>
    </section>
  )}

  <!-- Similar Businesses -->
  {(transformedSimilarBusinesses.length > 0 || placeholderBusinesses.length > 0) && (
    <section class="py-16 bg-gray-50 relative">
      <!-- Map Background Strip -->
      <div class="absolute inset-0 bg-gradient-to-b from-green-50 to-gray-100 opacity-60"></div>
      <div class="absolute inset-0" style="background-image: url('https://images.pexels.com/photos/2662116/pexels-photo-2662116.jpeg?auto=compress&cs=tinysrgb&w=1200'); background-size: cover; background-position: center; opacity: 0.1;"></div>
      
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">Similar Businesses</h2>
          <p class="text-gray-600 max-w-2xl mx-auto">
            Looking for something else? Here are other Abbotsford businesses worth checking out.
          </p>
          
          <div class="mt-8 mb-12">
            <a href="/list-business" class="bg-primary-700 text-white px-8 py-3 rounded-xl hover:bg-primary-800 transition-colors duration-200 font-medium">
              List Your Business
            </a>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 text-center mb-8">
          <h3 class="text-xl font-semibold text-gray-900 mb-4">Feature Your Business Here - For Free!</h3>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8 relative z-10">
          {transformedSimilarBusinesses.map((business) => (
            <BusinessCard business={business} variant="minimal" />
          ))}
        </div>

        {placeholderBusinesses.length > 0 && (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 relative z-10">
          {placeholderBusinesses.map((business, index) => (
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 p-6 text-center">
              <div class="w-32 h-20 bg-gray-200 rounded-lg mx-auto mb-4 flex items-center justify-center">
                <span class="text-gray-500 font-semibold text-sm">COMPANY LOGO</span>
              </div>
              
              <h3 class="font-semibold text-lg text-gray-900 mb-4">{business.name}</h3>
              
              <div class="space-y-2 text-sm text-gray-700 mb-6">
                <div>
                  {business.address}
                </div>
                <div>
                  {business.phone}
                </div>
                <div>
                  {business.email}
                </div>
              </div>
              
              <a href={business.website} target="_blank" rel="nofollow noopener noreferrer" 
                 class="inline-block bg-gray-100 text-gray-700 px-6 py-2 rounded-full border border-gray-300 hover:bg-gray-200 transition-colors duration-200 text-sm font-medium">
                Website
              </a>
            </div>
          ))}
          </div>
        )}
      </div>
    </section>
  )}

  <Footer />
</Layout>